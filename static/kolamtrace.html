<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KolamTrace | KolamVerse</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/kolamtrace.css">
    <style>
        /* Extension styles for narration panel matching existing palette */
        #descriptionSection {
            display: none;
            max-width: 1200px;
            margin: 40px auto;
            background: #23262e;
            border: 1px solid #2d333b;
            border-radius: 28px;
            padding: 28px 34px 34px;
            box-shadow: 0 2px 34px rgba(12, 18, 22, 0.4);
        }

        #descriptionSection.show {
            display: block;
            animation: fadeIn .25s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #kolamDescription {
            margin: 0;
            padding: 18px 20px;
            background: #191e24;
            border: 1px solid #2a3036;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.55;
            max-height: 320px;
            overflow: auto;
            white-space: pre-wrap;
            color: #d5dde4;
            box-shadow: inset 0 0 0 1px #1f2429;
        }

        .desc-header {
            display: flex;
            flex-wrap: wrap;
            gap: 26px;
            align-items: flex-start;
        }

        .desc-header h2 {
            margin: 0 0 6px;
            font-size: 22px;
            font-weight: 600;
            letter-spacing: .5px;
            color: #78f5c6;
        }

        .narration-mode {
            background: #191e24;
            border: 1px solid #30363d;
            padding: 12px 16px 10px;
            border-radius: 14px;
        }

        .narration-mode fieldset {
            border: none;
            margin: 0;
            padding: 0;
        }

        .narration-mode legend {
            font-size: 12px;
            letter-spacing: 1px;
            color: #9fb4c3;
            margin-bottom: 6px;
        }

        .narration-mode label {
            display: block;
            font-size: 12.5px;
            margin: 4px 0;
            color: #c9d1d9;
        }

        .narration-mode input {
            margin-right: 6px;
        }

        .source-tag {
            display: inline-block;
            background: #30363d;
            color: #9fb4c3;
            font-size: 11px;
            letter-spacing: .8px;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .loading-description {
            background: #1c2128;
            border: 1px solid #30363d;
            padding: 14px 18px;
            border-radius: 12px;
            font-style: italic;
            color: #8b949e;
        }

        @media (max-width:1000px) {
            #descriptionSection {
                margin: 28px 18px;
                border-radius: 20px;
                padding: 22px 24px 26px;
            }
        }

        .hidden {
            display: none;
        }

        .flex-grow {
            flex: 1;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0 0 0 0);
            border: 0;
        }
    </style>
</head>

<body>
    <div class="trace-bar">
        <div class="brand">
            <svg class="kolam-svg" fill="none" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="32" stroke="#c00" stroke-width="2" />
                <ellipse cx="35" cy="35" rx="22" ry="22" stroke="#ffffff" stroke-width="2" />
                <path stroke="#c00" stroke-width="1.8" d="M12 35 Q35 10 58 35 Q35 60 12 35 Z" />
                <circle cx="35" cy="17" r="2" fill="#ffffff" />
                <circle cx="35" cy="53" r="2" fill="#ffffff" />
                <circle cx="17" cy="35" r="2" fill="#ffffff" />
                <circle cx="53" cy="35" r="2" fill="#ffffff" />
            </svg>
            <h1><a href="/">KolamVerse</a></h1>
        </div>
        <span class="section-title">KolamTrace</span>
    </div>

    <div class="main-flex">
        <div class="upload-side">
            <h2>1. Upload Kolam Image</h2>
            <div class="img-slot" id="preview-box">
                <img id="preview-img" class="hidden" src="" alt="Your image preview" />
                <span class="slot-placeholder" id="preview-placeholder">No image uploaded</span>
            </div>
            <label class="upload-label" for="kolam-upload">Choose Image
                <input type="file" id="kolam-upload" accept="image/*" />
            </label>
            <div class="info">JPG, PNG • Max 2MB</div>
        </div>
        <div class="anim-panel">
            <h2>2. Kolam Animation</h2>
            <div class="anim-area" id="anim-area">
                <div class="anim-placeholder" id="anim-placeholder">
                    Upload a Kolam image and press <b>Animate</b> to view the tracing animation!
                </div>
                <canvas id="animationCanvas" width="410" height="370"></canvas>
            </div>
            <div class="actions">
                <button id="animate-btn" disabled>Animate</button>
                <button id="back20" disabled>&laquo; 20 Frames</button>
                <label for="frameSlider" class="visually-hidden">Frame position</label>
                <input type="range" id="frameSlider" min="0" max="0" value="0" class="flex-grow"
                    title="Frame position" />
                <button id="forward20" disabled>20 Frames &raquo;</button>
                <button id="show-curve" disabled>Show Mathematical Curve</button>
                <label style="color:#78f5c6;">Samples <input type="number" id="curve-samples" value="1200" min="100"
                        max="20000" style="width:90px; margin-left:6px;"></label>
                <label style="color:#78f5c6;">Smooth <input type="number" id="curve-smooth" value="0" min="0" max="1000"
                        step="1" style="width:70px; margin-left:6px;"></label>
            </div>
            <div id="curve-panel" style="margin-top:18px; display:none; width:100%;">
                <div style="display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;">
                    <img id="curvePreview" src="" alt="Spline curve"
                        style="max-width:410px; min-height:120px; background:#23262e; border-radius:12px; border:2px solid #30363d;" />
                    <div style="flex:1; min-width:280px; color:#c9d1d9;">
                        <h3 style="margin-top:0; color:#78f5c6;">Mathematical Curve (B‑spline)</h3>
                        <p style="margin:4px 0 6px 0; font-style:italic; color:#9ec6ae;">Derived from the traced CSV
                            points by fitting a cubic B‑spline x(t), y(t). Download JSON to view knots and coefficients
                            for verification (e.g., Desmos).</p>
                        <p style="margin:6px 0 10px 0;">Parametric form per interval [t<sub>i</sub>,
                            t<sub>i+1</sub>]:<br>
                            x(t) = a<sub>xi</sub> + b<sub>xi</sub>τ + c<sub>xi</sub>τ² + d<sub>xi</sub>τ³;<br>
                            y(t) = a<sub>yi</sub> + b<sub>yi</sub>τ + c<sub>yi</sub>τ² + d<sub>yi</sub>τ³ (τ = t −
                            t<sub>i</sub>)</p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                            <a id="downloadPoints" class="link-button" href="#" download>Download Points (CSV)</a>
                            <a id="downloadJSON" class="link-button" href="#" download>Download Spline (JSON)</a>
                        </div>
                        <details>
                            <summary style="cursor:pointer; color:#78f5c6;">Open Desmos instructions</summary>
                            <ol>
                                <li>Open <a href="https://www.desmos.com/calculator" target="_blank"
                                        rel="noreferrer">Desmos</a>.</li>
                                <li>Click the + → Table → paste two columns from the CSV (x,y).</li>
                                <li>Add a line: <code>y \\sim f(x)</code> or use parametric by plotting successive
                                    segments.</li>
                                <li>Style: thick white curve, dark green background (#2e5f3b).</li>
                            </ol>
                        </details>
                        <details>
                            <summary style="cursor:pointer; color:#78f5c6;">Use exact formula in Desmos (B‑spline)
                            </summary>
                            <ol>
                                <li>Click <b>Download Spline (JSON)</b> above. Copy arrays <code>T</code> (knots),
                                    <code>Cx</code>, <code>Cy</code>.
                                </li>
                                <li>In Desmos, add expressions (one per line):</li>
                            </ol>
                            <pre
                                style="white-space:pre-wrap; background:#0d1117; color:#c9d1d9; padding:10px; border-radius:8px; border:1px solid #30363d;">
T = [ ...paste knots from JSON... ]
Cx = [ ...paste cx from JSON... ]
Cy = [ ...paste cy from JSON... ]
B0(i,t) = when( T[i] ≤ t and t < T[i+1], 1, 0 )
B1(i,t) = ((t - T[i])/(T[i+1]-T[i]))*B0(i,t) + ((T[i+2]-t)/(T[i+2]-T[i+1]))*B0(i+1,t)
B2(i,t) = ((t - T[i])/(T[i+2]-T[i]))*B1(i,t) + ((T[i+3]-t)/(T[i+3]-T[i+1]))*B1(i+1,t)
B3(i,t) = ((t - T[i])/(T[i+3]-T[i]))*B2(i,t) + ((T[i+4]-t)/(T[i+4]-T[i+1]))*B2(i+1,t)
x(t) = sum( Cx[i]*B3(i,t), i, 1, length(Cx) )
y(t) = sum( Cy[i]*B3(i,t), i, 1, length(Cy) )
( x(t), y(t) ), t ∈ [ T[4], T[length(T)-3] ]
</pre>
                            <p style="margin-top:6px;">This reproduces the same cubic B‑spline used in the app.</p>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section id="descriptionSection" aria-live="polite" aria-label="Kolam Description Panel">
        <div class="desc-header">
            <h2>Kolam Description</h2>
            <div class="narration-mode" role="group" aria-label="Narration Mode Selection">
                <fieldset>
                    <legend>NARRATION MODE</legend>
                    <label><input type="radio" name="nmode" value="offline" checked> Offline (no AI)</label>
                    <label><input type="radio" name="nmode" value="auto"> Auto (AI w/ fallback)</label>
                    <label><input type="radio" name="nmode" value="ai"> Force AI</label>
                </fieldset>
            </div>
            <span id="narrationSource" class="source-tag" hidden></span>
        </div>
        <pre id="kolamDescription"></pre>
    </section>

    <script src="/assets/kolamtrace.js"></script>
</body>

</html>