<form id="uploadForm">
    <input type="file" id="fileInput" name="file" accept="image/*" required>
    <button type="submit">Upload & Animate</button>
</form>

<div class="preview-container">
    <div>
        <h3>Selected Picture</h3>
        <img id="selected" alt="Your uploaded picture will appear here">
    </div>

    <div>
        <h3>Kolam Animation</h3>
        <canvas id="animationCanvas" width="400" height="400"></canvas>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button id="back20" disabled>« PREV</button>
            <input type="range" id="frameSlider" min="0" max="0" value="0" style="flex: 1;">
            <button id="forward20" disabled>NEXT »</button>
        </div>
    </div>
</div>

<style>
    .preview-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }

    .preview-container>div {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .preview-container img,
    .preview-container canvas {
        max-width: 400px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    button {
        margin: 2px;
    }
</style>

<script>
    class KolamAnimator {
        constructor({ fileInputId, formId, selectedImgId, canvasId, sliderId, backBtnId, forwardBtnId }) {
            this.fileInput = document.getElementById(fileInputId);
            this.form = document.getElementById(formId);
            this.selectedImg = document.getElementById(selectedImgId);
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext("2d");
            this.slider = document.getElementById(sliderId);
            this.backBtn = document.getElementById(backBtnId);
            this.forwardBtn = document.getElementById(forwardBtnId);

            this.frames = [];
            this.currentFrame = 0;
            this.liveInterval = null;
            this.navImg = new Image();
            this.FRAMESKIP = 20;

            this._bindEvents();
        }

        _bindEvents() {
            this.fileInput.addEventListener("change", () => this._previewSelected());
            this.form.addEventListener("submit", (e) => this._handleUpload(e));
            this.slider.addEventListener("input", () => this._updateFrame(this.slider.value));
            this.backBtn.addEventListener("click", () => this._updateFrame(this.currentFrame - this.FRAMESKIP));
            this.forwardBtn.addEventListener("click", () => this._updateFrame(this.currentFrame + this.FRAMESKIP));
        }

        _previewSelected() {
            const file = this.fileInput.files[0];
            if (file) this.selectedImg.src = URL.createObjectURL(file);
        }

        async _handleUpload(e) {
            e.preventDefault();
            const file = this.fileInput.files[0];
            if (!file) return alert("Select a file.");

            this._resetState();
            this.selectedImg.src = URL.createObjectURL(file);

            try {
                const formData = new FormData();
                formData.append("file", file);

                const res = await fetch("/upload_kolam", { method: "POST", body: formData });
                const data = await res.json();
                if (data.error) return alert("Error: " + data.error);

                this._startLiveMJPEG(data.csv_file);
                this._pollSnapshots();
            } catch (err) {
                console.error("Upload failed:", err);
            }
        }

        _resetState() {
            this.frames = [];
            this.currentFrame = 0;
            this.slider.value = 0;
            this.slider.max = 0;
            this.backBtn.disabled = true;
            this.forwardBtn.disabled = true;
            if (this.liveInterval) clearInterval(this.liveInterval);
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }

        _startLiveMJPEG(csvFile) {
            if (this.liveInterval) clearInterval(this.liveInterval);
            const streamImg = new Image();
            streamImg.src = `/animate_kolam?csv_file=${encodeURIComponent(csvFile)}`;
            streamImg.crossOrigin = "anonymous";

            this.liveInterval = setInterval(() => {
                try { this.ctx.drawImage(streamImg, 0, 0, this.canvas.width, this.canvas.height); }
                catch (e) { }
            }, 30);
        }

        async _pollSnapshots() {
            try {
                const snapRes = await fetch(`/kolam_snapshots`);
                if (!snapRes.ok) { setTimeout(() => this._pollSnapshots(), 4000); return; }

                const snapData = await snapRes.json();
                this.frames = snapData.frames;
                this.currentFrame = this.frames.length - 1;

                clearInterval(this.liveInterval);
                this._updateFrame(this.currentFrame);

                // Enable controls
                this.slider.max = this.frames.length - 1;
                this.slider.value = this.currentFrame;
                this._updateNavButtons();
            } catch (err) {
                setTimeout(() => this._pollSnapshots(), 4000);
            }
        }

        _updateFrame(idx) {
            if (this.frames.length === 0) return;
            this.currentFrame = Math.max(0, Math.min(idx, this.frames.length - 1));
            this.navImg.onload = () => this.ctx.drawImage(this.navImg, 0, 0, this.canvas.width, this.canvas.height);
            this.navImg.src = "data:image/jpeg;base64," + this.frames[this.currentFrame];

            // Update slider and buttons
            this.slider.value = this.currentFrame;
            this._updateNavButtons();
        }

        _updateNavButtons() {
            this.backBtn.disabled = this.currentFrame === 0;
            this.forwardBtn.disabled = this.currentFrame >= this.frames.length - 1;
        }
    }

    // Initialize
    new KolamAnimator({
        fileInputId: "fileInput",
        formId: "uploadForm",
        selectedImgId: "selected",
        canvasId: "animationCanvas",
        sliderId: "frameSlider",
        backBtnId: "back20",
        forwardBtnId: "forward20"
    });
</script>