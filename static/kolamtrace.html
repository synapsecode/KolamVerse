<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KolamTrace | KolamVerse</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/kolamtrace.css">
</head>

<body>
    <div class="trace-bar">
        <div class="brand">
            <svg class="kolam-svg" fill="none" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="32" stroke="#c00" stroke-width="2" />
                <ellipse cx="35" cy="35" rx="22" ry="22" stroke="#ffffff" stroke-width="2" />
                <path stroke="#c00" stroke-width="1.8" d="M12 35 Q35 10 58 35 Q35 60 12 35 Z" />
                <circle cx="35" cy="17" r="2" fill="#ffffff" />
                <circle cx="35" cy="53" r="2" fill="#ffffff" />
                <circle cx="17" cy="35" r="2" fill="#ffffff" />
                <circle cx="53" cy="35" r="2" fill="#ffffff" />
            </svg>
            <h1><a href="/">KolamVerse</a></h1>
        </div>
        <span class="section-title">KolamTrace</span>
    </div>

    <div class="main-flex">
        <!-- Upload Side -->
        <div class="upload-side">
            <h2>1. Upload Kolam Image</h2>
            <div class="img-slot" id="preview-box">
                <img id="preview-img" src="" alt="Your image preview" style="display: none;" />
                <span class="slot-placeholder" id="preview-placeholder">No image uploaded</span>
            </div>
            <label class="upload-label" for="kolam-upload">Choose Image
                <input type="file" id="kolam-upload" accept="image/*" />
            </label>
            <div class="info">JPG, PNG • Max 2MB</div>
        </div>

        <!-- Animation Panel -->
        <div class="anim-panel">
            <h2>2. Kolam Animation</h2>
            <div class="anim-area" id="anim-area">
                <div class="anim-placeholder" id="anim-placeholder">
                    Upload a Kolam image and press <b>Animate</b> to view the tracing animation!
                </div>
                <canvas id="animationCanvas" width="410" height="370"></canvas>
            </div>
            <div class="actions">
                <button id="animate-btn" disabled>Animate</button>
                <button id="back20" disabled>&laquo; 20 Frames</button>
                <input type="range" id="frameSlider" min="0" max="0" value="0" style="flex: 1;">
                <button id="forward20" disabled>20 Frames &raquo;</button>
                <button id="show-curve" disabled>Show Mathematical Curve</button>
                <label style="color:#78f5c6;">Samples <input type="number" id="curve-samples" value="1200" min="100" max="20000" style="width:90px; margin-left:6px;"></label>
                <label style="color:#78f5c6;">Smooth <input type="number" id="curve-smooth" value="0" min="0" max="1000" step="1" style="width:70px; margin-left:6px;"></label>
            </div>
            <div id="curve-panel" style="margin-top:18px; display:none; width:100%;">
                <div style="display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;">
                    <img id="curvePreview" src="" alt="Spline curve" style="max-width:410px; min-height:120px; background:#23262e; border-radius:12px; border:2px solid #30363d;" />
                    <div style="flex:1; min-width:280px; color:#c9d1d9;">
                        <h3 style="margin-top:0; color:#78f5c6;">Mathematical Curve (B‑spline)</h3>
                        <p style="margin:4px 0 6px 0; font-style:italic; color:#9ec6ae;">Derived from the traced CSV points by fitting a cubic B‑spline x(t), y(t). Download JSON to view knots and coefficients for verification (e.g., Desmos).</p>
                        <p style="margin:6px 0 10px 0;">Parametric form per interval [t<sub>i</sub>, t<sub>i+1</sub>]:<br>
                        x(t) = a<sub>xi</sub> + b<sub>xi</sub>τ + c<sub>xi</sub>τ² + d<sub>xi</sub>τ³;<br>
                        y(t) = a<sub>yi</sub> + b<sub>yi</sub>τ + c<sub>yi</sub>τ² + d<sub>yi</sub>τ³ (τ = t − t<sub>i</sub>)</p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                            <a id="downloadPoints" class="link-button" href="#" download>Download Points (CSV)</a>
                            <a id="downloadJSON" class="link-button" href="#" download>Download Spline (JSON)</a>
                        </div>
                        <details>
                            <summary style="cursor:pointer; color:#78f5c6;">Open Desmos instructions</summary>
                            <ol>
                                <li>Open <a href="https://www.desmos.com/calculator" target="_blank" rel="noreferrer">Desmos</a>.</li>
                                <li>Click the + → Table → paste two columns from the CSV (x,y).</li>
                                <li>Add a line: <code>y \\sim f(x)</code> or use parametric by plotting successive segments.</li>
                                <li>Style: thick white curve, dark green background (#2e5f3b).</li>
                            </ol>
                        </details>
                        <details>
                            <summary style="cursor:pointer; color:#78f5c6;">Use exact formula in Desmos (B‑spline)</summary>
                            <ol>
                                <li>Click <b>Download Spline (JSON)</b> above. Copy arrays <code>T</code> (knots), <code>Cx</code>, <code>Cy</code>.</li>
                                <li>In Desmos, add expressions (one per line):</li>
                            </ol>
<pre style="white-space:pre-wrap; background:#0d1117; color:#c9d1d9; padding:10px; border-radius:8px; border:1px solid #30363d;">
T = [ ...paste knots from JSON... ]
Cx = [ ...paste cx from JSON... ]
Cy = [ ...paste cy from JSON... ]
B0(i,t) = when( T[i] ≤ t and t < T[i+1], 1, 0 )
B1(i,t) = ((t - T[i])/(T[i+1]-T[i]))*B0(i,t) + ((T[i+2]-t)/(T[i+2]-T[i+1]))*B0(i+1,t)
B2(i,t) = ((t - T[i])/(T[i+2]-T[i]))*B1(i,t) + ((T[i+3]-t)/(T[i+3]-T[i+1]))*B1(i+1,t)
B3(i,t) = ((t - T[i])/(T[i+3]-T[i]))*B2(i,t) + ((T[i+4]-t)/(T[i+4]-T[i+1]))*B2(i+1,t)
x(t) = sum( Cx[i]*B3(i,t), i, 1, length(Cx) )
y(t) = sum( Cy[i]*B3(i,t), i, 1, length(Cy) )
( x(t), y(t) ), t ∈ [ T[4], T[length(T)-3] ]
</pre>
                            <p style="margin-top:6px;">This reproduces the same cubic B‑spline used in the app.</p>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class KolamAnimator {
            constructor({ fileInputId, previewImgId, placeholderId, animateBtnId, canvasId, backBtnId, forwardBtnId, sliderId, showCurveBtnId, curveImgId, curveSamplesId, curveSmoothId, curvePanelId, downloadPointsId, downloadJSONId }) {
                this.fileInput = document.getElementById(fileInputId);
                this.previewImg = document.getElementById(previewImgId);
                this.placeholder = document.getElementById(placeholderId);
                this.animateBtn = document.getElementById(animateBtnId);
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext("2d");
                this.backBtn = document.getElementById(backBtnId);
                this.forwardBtn = document.getElementById(forwardBtnId);
                this.slider = document.getElementById(sliderId);
                this.showCurveBtn = document.getElementById(showCurveBtnId);
                this.curveImg = document.getElementById(curveImgId);
                this.curveSamples = document.getElementById(curveSamplesId);
                this.curveSmooth = document.getElementById(curveSmoothId);
                this.curvePanel = document.getElementById(curvePanelId);
                this.downloadPoints = document.getElementById(downloadPointsId);
                this.downloadJSON = document.getElementById(downloadJSONId);

                this.frames = [];
                this.currentFrame = 0;
                this.liveInterval = null;
                this.navImg = new Image();
                this.FRAMESKIP = 20;
                this.csvFile = null;

                this._bindEvents();
            }

            _bindEvents() {
                this.fileInput.addEventListener("change", () => this._previewSelected());
                this.animateBtn.addEventListener("click", () => this._handleUpload());
                this.backBtn.addEventListener("click", () => this._updateFrame(this.currentFrame - this.FRAMESKIP));
                this.forwardBtn.addEventListener("click", () => this._updateFrame(this.currentFrame + this.FRAMESKIP));
                this.slider.addEventListener("input", () => this._updateFrame(parseInt(this.slider.value)));
                this.showCurveBtn.addEventListener("click", () => this._showCurve());
            }

            _previewSelected() {
                const file = this.fileInput.files[0];
                if (file) {
                    this.previewImg.src = URL.createObjectURL(file);
                    this.previewImg.style.display = "block";
                    this.placeholder.style.display = "none";
                    this.animateBtn.disabled = false;
                    this.showCurveBtn.disabled = true;
                    this.curveImg.style.display = "none";
                }
            }

            async _handleUpload() {
                const file = this.fileInput.files[0];
                if (!file) return alert("Select a file.");
                this._resetState();
                this.previewImg.src = URL.createObjectURL(file);

                try {
                    const formData = new FormData();
                    formData.append("file", file);
                    const res = await fetch("/upload_kolam", { method: "POST", body: formData });
                    const data = await res.json();
                    if (data.error) return alert("Error: " + data.error);

                    this.csvFile = data.csv_file;
                    this._startLiveMJPEG(this.csvFile);
                    this._pollSnapshots();
                    this.showCurveBtn.disabled = false;
                } catch (err) {
                    console.error("Upload failed:", err);
                }
            }

            _resetState() {
                this.frames = [];
                this.currentFrame = 0;
                this.backBtn.disabled = true;
                this.forwardBtn.disabled = true;
                this.animateBtn.disabled = true;
                this.slider.value = 0;
                this.slider.max = 0;
                if (this.liveInterval) clearInterval(this.liveInterval);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.curvePanel.style.display = "none";
            }

            _startLiveMJPEG(csvFile) {
                if (this.liveInterval) clearInterval(this.liveInterval);
                document.getElementById("anim-placeholder").style.display = 'none'
                const streamImg = new Image();
                streamImg.src = `/animate_kolam?csv_file=${encodeURIComponent(csvFile)}`;
                streamImg.crossOrigin = "anonymous";

                this.liveInterval = setInterval(() => {
                    try { this.ctx.drawImage(streamImg, 0, 0, this.canvas.width, this.canvas.height); }
                    catch (e) { }
                }, 30);
            }

            async _pollSnapshots() {
                try {
                    const snapRes = await fetch(`/kolam_snapshots`);
                    if (!snapRes.ok) { setTimeout(() => this._pollSnapshots(), 4000); return; }

                    const snapData = await snapRes.json();
                    this.frames = snapData.frames;
                    this.currentFrame = this.frames.length - 1;

                    clearInterval(this.liveInterval);
                    this._updateFrame(this.currentFrame);

                    // Enable controls
                    this.slider.max = this.frames.length - 1;
                    this.slider.value = this.currentFrame;
                } catch (err) {
                    setTimeout(() => this._pollSnapshots(), 4000);
                }
            }

            _updateFrame(idx) {
                if (this.frames.length === 0) return;
                this.currentFrame = Math.max(0, Math.min(idx, this.frames.length - 1));
                this.navImg.onload = () => this.ctx.drawImage(this.navImg, 0, 0, this.canvas.width, this.canvas.height);
                this.navImg.src = "data:image/jpeg;base64," + this.frames[this.currentFrame];

                // Update slider and buttons
                this.slider.value = this.currentFrame;
                this.backBtn.disabled = this.currentFrame === 0;
                this.forwardBtn.disabled = this.currentFrame >= this.frames.length - 1;
            }

            _showCurve() {
                if (!this.csvFile) {
                    alert("Upload and animate first");
                    return;
                }
                const w = this.canvas.width;
                const h = this.canvas.height;
                const samples = Math.max(100, Math.min(20000, parseInt(this.curveSamples.value) || 1200));
                const smooth = Math.max(0, Math.min(1000, parseFloat(this.curveSmooth.value) || 0));
                // cache buster so the browser reloads new image
                const ts = Date.now();
                const url = `/spline_curve?csv_file=${encodeURIComponent(this.csvFile)}&width=${w}&height=${h}&samples=${samples}&smooth=${smooth}&thickness=4&ts=${ts}`;
                this.curveImg.src = url;                        // large panel preview
                this.curveImg.style.display = 'block';
                this.curvePanel.style.display = "block";

                // Set download links
                this.downloadPoints.href = `/spline_points?csv_file=${encodeURIComponent(this.csvFile)}&samples=${samples}&smooth=${smooth}`;
                this.downloadJSON.href = `/spline_json?csv_file=${encodeURIComponent(this.csvFile)}&smooth=${smooth}`;
            }
        }

        new KolamAnimator({
            fileInputId: "kolam-upload",
            previewImgId: "preview-img",
            placeholderId: "preview-placeholder",
            animateBtnId: "animate-btn",
            canvasId: "animationCanvas",
            backBtnId: "back20",
            forwardBtnId: "forward20",
            sliderId: "frameSlider",
            showCurveBtnId: "show-curve",
            curveImgId: "curvePreview",
            curveSamplesId: "curve-samples",
            curveSmoothId: "curve-smooth",
            curvePanelId: "curve-panel",
            downloadPointsId: "downloadPoints",
            downloadJSONId: "downloadJSON"
        });
    </script>
</body>

</html>