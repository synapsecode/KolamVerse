<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KolamTrace | KolamVerse</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/kolamtrace.css">
</head>

<body>
    <div class="trace-bar">
        <div class="brand">
            <svg class="kolam-svg" fill="none" viewBox="0 0 70 70">
                <circle cx="35" cy="35" r="32" stroke="#c00" stroke-width="2" />
                <ellipse cx="35" cy="35" rx="22" ry="22" stroke="#ffffff" stroke-width="2" />
                <path stroke="#c00" stroke-width="1.8" d="M12 35 Q35 10 58 35 Q35 60 12 35 Z" />
                <circle cx="35" cy="17" r="2" fill="#ffffff" />
                <circle cx="35" cy="53" r="2" fill="#ffffff" />
                <circle cx="17" cy="35" r="2" fill="#ffffff" />
                <circle cx="53" cy="35" r="2" fill="#ffffff" />
            </svg>
            <h1><a href="/">KolamVerse</a></h1>
        </div>
        <span class="section-title">KolamTrace</span>
    </div>

    <div class="main-flex">
        <!-- Upload Side -->
        <div class="upload-side">
            <h2>1. Upload Kolam Image</h2>
            <div class="img-slot" id="preview-box">
                <img id="preview-img" src="" alt="Your image preview" style="display: none;" />
                <span class="slot-placeholder" id="preview-placeholder">No image uploaded</span>
            </div>
            <label class="upload-label" for="kolam-upload">Choose Image
                <input type="file" id="kolam-upload" accept="image/*" />
            </label>
            <div class="info">JPG, PNG â€¢ Max 2MB</div>
        </div>

        <!-- Animation Panel -->
        <div class="anim-panel">
            <h2>2. Kolam Animation</h2>
            <div class="anim-area" id="anim-area">
                <div class="anim-placeholder" id="anim-placeholder">
                    Upload a Kolam image and press <b>Animate</b> to view the tracing animation!
                </div>
                <canvas id="animationCanvas" width="410" height="370"></canvas>
            </div>
            <div class="actions">
                <button id="animate-btn" disabled>Animate</button>
                <button id="back20" disabled>&laquo; 20 Frames</button>
                <input type="range" id="frameSlider" min="0" max="0" value="0" style="flex: 1;">
                <button id="forward20" disabled>20 Frames &raquo;</button>
            </div>
        </div>
    </div>

    <script>
        class KolamAnimator {
            constructor({ fileInputId, previewImgId, placeholderId, animateBtnId, canvasId, backBtnId, forwardBtnId, sliderId }) {
                this.fileInput = document.getElementById(fileInputId);
                this.previewImg = document.getElementById(previewImgId);
                this.placeholder = document.getElementById(placeholderId);
                this.animateBtn = document.getElementById(animateBtnId);
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext("2d");
                this.backBtn = document.getElementById(backBtnId);
                this.forwardBtn = document.getElementById(forwardBtnId);
                this.slider = document.getElementById(sliderId);

                this.frames = [];
                this.currentFrame = 0;
                this.liveInterval = null;
                this.navImg = new Image();
                this.FRAMESKIP = 20;
                this.csvFile = null;

                this._bindEvents();
            }

            _bindEvents() {
                this.fileInput.addEventListener("change", () => this._previewSelected());
                this.animateBtn.addEventListener("click", () => this._handleUpload());
                this.backBtn.addEventListener("click", () => this._updateFrame(this.currentFrame - this.FRAMESKIP));
                this.forwardBtn.addEventListener("click", () => this._updateFrame(this.currentFrame + this.FRAMESKIP));
                this.slider.addEventListener("input", () => this._updateFrame(parseInt(this.slider.value)));
            }

            _previewSelected() {
                const file = this.fileInput.files[0];
                if (file) {
                    this.previewImg.src = URL.createObjectURL(file);
                    this.previewImg.style.display = "block";
                    this.placeholder.style.display = "none";
                    this.animateBtn.disabled = false;
                }
            }

            async _handleUpload() {
                const file = this.fileInput.files[0];
                if (!file) return alert("Select a file.");
                this._resetState();
                this.previewImg.src = URL.createObjectURL(file);

                try {
                    const formData = new FormData();
                    formData.append("file", file);
                    const res = await fetch("/upload_kolam", { method: "POST", body: formData });
                    const data = await res.json();
                    if (data.error) return alert("Error: " + data.error);

                    this.csvFile = data.csv_file;
                    this._startLiveMJPEG(this.csvFile);
                    this._pollSnapshots();
                } catch (err) {
                    console.error("Upload failed:", err);
                }
            }

            _resetState() {
                this.frames = [];
                this.currentFrame = 0;
                this.backBtn.disabled = true;
                this.forwardBtn.disabled = true;
                this.animateBtn.disabled = true;
                this.slider.value = 0;
                this.slider.max = 0;
                if (this.liveInterval) clearInterval(this.liveInterval);
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            _startLiveMJPEG(csvFile) {
                if (this.liveInterval) clearInterval(this.liveInterval);
                document.getElementById("anim-placeholder").style.display = 'none'
                const streamImg = new Image();
                streamImg.src = `/animate_kolam?csv_file=${encodeURIComponent(csvFile)}`;
                streamImg.crossOrigin = "anonymous";

                this.liveInterval = setInterval(() => {
                    try { this.ctx.drawImage(streamImg, 0, 0, this.canvas.width, this.canvas.height); }
                    catch (e) { }
                }, 30);
            }

            async _pollSnapshots() {
                try {
                    const snapRes = await fetch(`/kolam_snapshots`);
                    if (!snapRes.ok) { setTimeout(() => this._pollSnapshots(), 4000); return; }

                    const snapData = await snapRes.json();
                    this.frames = snapData.frames;
                    this.currentFrame = this.frames.length - 1;

                    clearInterval(this.liveInterval);
                    this._updateFrame(this.currentFrame);

                    // Enable controls
                    this.slider.max = this.frames.length - 1;
                    this.slider.value = this.currentFrame;
                } catch (err) {
                    setTimeout(() => this._pollSnapshots(), 4000);
                }
            }

            _updateFrame(idx) {
                if (this.frames.length === 0) return;
                this.currentFrame = Math.max(0, Math.min(idx, this.frames.length - 1));
                this.navImg.onload = () => this.ctx.drawImage(this.navImg, 0, 0, this.canvas.width, this.canvas.height);
                this.navImg.src = "data:image/jpeg;base64," + this.frames[this.currentFrame];

                // Update slider and buttons
                this.slider.value = this.currentFrame;
                this.backBtn.disabled = this.currentFrame === 0;
                this.forwardBtn.disabled = this.currentFrame >= this.frames.length - 1;
            }
        }

        new KolamAnimator({
            fileInputId: "kolam-upload",
            previewImgId: "preview-img",
            placeholderId: "preview-placeholder",
            animateBtnId: "animate-btn",
            canvasId: "animationCanvas",
            backBtnId: "back20",
            forwardBtnId: "forward20",
            sliderId: "frameSlider"
        });
    </script>
</body>

</html>