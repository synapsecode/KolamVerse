<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KolamTrace | KolamVerse</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --accent: #28a956;
        --accent-dark: #208a3d;
        --accent-fade: #111316;
        --bg: #181d22;
        --shadow: 0 2px 24px rgba(0, 0, 0, 0.28);
      }
      body {
        margin: 0;
        font-family: 'Inter', 'Segoe UI', sans-serif;
        background: #181b20;
        color: #e0e6ed;
        min-height: 100vh;
      }
      .trace-bar {
        display: flex;
        align-items: center;
        gap: 18px;
        background: #22262c;
        padding: 12px 48px;
        border-bottom: 1.5px solid #232a33;
      }
      .trace-bar .brand {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 4px;
      }
      .trace-bar .brand h1 a {
        text-decoration: none;
        color: #e0e6ed;
      }
      .trace-bar .brand svg {
        height: 42px;
        width: 42px;
      }
      .trace-bar .section-title {
        color: #78f5c6;
      }
      /* Main container */
      .main-flex {
        max-width: 1200px;
        background: #23262e;
        margin: 40px auto 0 auto;
        border-radius: 34px;
        box-shadow: 0 2px 40px rgba(20, 32, 44, 0.15);
        display: flex;
        min-height: 560px;
        overflow: hidden;
      }
      /* Upload area */
      .upload-side {
        min-width: 315px;
        max-width: 360px;
        background: #191e24;
        border-right: 1.5px solid #21252d;
        padding: 50px 28px 30px 28px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .upload-side h2 {
        color: #78f5c6;
      }
      .img-slot {
        width: 220px;
        height: 220px;
        background: #23262e;
        border: 2px dashed #79e3b7;
        border-radius: 16px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 18px;
        position: relative;
        overflow: hidden;
      }
      .img-slot img {
        max-width: 100%;
        max-height: 180px;
        border-radius: 10px;
      }
      .img-slot .slot-placeholder {
        color: #7a8ca2;
      }
      .upload-label {
        background: linear-gradient(100deg, #29a459 60%, #63d8a7 100%);
        color: #14312c;
        padding: 12px 25px;
        margin-bottom: 8px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 2px 10px rgba(24, 97, 76, 0.18);
      }
      .upload-label:active,
      .upload-label:focus {
        background: #146b39;
        color: #cafff0;
      }
      input[type='file'] {
        display: none;
      }
      .info {
        color: #67eeb5;
      }
      .anim-panel {
        flex: 1 1 640px;
        padding: 54px 54px 20px 54px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 320px;
      }
      .anim-panel h2 {
        color: #78f5c6;
      }
      .anim-area {
        width: 410px;
        height: 370px;
        background: #23262e;
        border-radius: 22px;
        box-shadow: 0 4px 28px rgba(8, 16, 28, 0.14);
      }
      .anim-placeholder {
        color: #4e6074;
      }
      #animationCanvas {
        background: transparent;
        border-radius: 22px;
        box-shadow: 0 4px 18px rgba(34, 211, 138, 0.05);
      }
      .actions button {
        background: linear-gradient(100deg, #22693e 60%, #2eb495 100%);
        color: #e2f6eb;
        font-weight: 700;
        font-size: 1.1rem;
        border-radius: 12px;
        border: none;
        outline: none;
        cursor: pointer;
      }
      .actions button:disabled {
        background: #20272b;
        color: #48655a;
      }
      /* Additional responsive/theme tweaks as per your original CSS */
      @media (max-width: 1000px) {
        .main-flex {
          flex-direction: column;
          min-height: unset;
        }
        .upload-side,
        .anim-panel {
          min-width: unset;
          max-width: unset;
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #23262e;
        }
        .anim-panel {
          padding: 24px 28px 20px 28px;
        }
        .img-slot {
          width: 100%;
          height: auto;
          max-height: 280px;
        }
        #animationCanvas {
          width: 100% !important;
          height: auto !important;
        }
      }

      @media (max-width: 600px) {
        .main-flex {
          border-radius: 0;
        }
        .section-title {
            display: none;
        }
        .anim-area {
            width: 310px;
            height: 340px;
        }
        .upload-side,
        .anim-panel {
          padding: 12px 16px;
        }
        .upload-side h2,
        .anim-panel h2 {
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="trace-bar">
      <div class="brand">
        <svg class="kolam-svg" fill="none" viewBox="0 0 70 70">
          <circle cx="35" cy="35" r="32" stroke="#c00" stroke-width="2" />
          <ellipse cx="35" cy="35" rx="22" ry="22" stroke="#ffffff" stroke-width="2" />
          <path stroke="#c00" stroke-width="1.8" d="M12 35 Q35 10 58 35 Q35 60 12 35 Z" />
          <circle cx="35" cy="17" r="2" fill="#ffffff" />
          <circle cx="35" cy="53" r="2" fill="#ffffff" />
          <circle cx="17" cy="35" r="2" fill="#ffffff" />
          <circle cx="53" cy="35" r="2" fill="#ffffff" />
        </svg>
        <h1><a href="/">KolamVerse</a></h1>
      </div>
      <span class="section-title">KolamTrace</span>
    </div>
    <div class="main-flex">
      <div class="upload-side">
        <h2>1. Upload Kolam Image</h2>
        <div class="img-slot" id="preview-box">
          <img id="preview-img" src="" alt="Your image preview" style="display: none" />
          <span class="slot-placeholder" id="preview-placeholder">No image uploaded</span>
        </div>
        <label class="upload-label" for="kolam-upload">
          <span>Choose Image</span>
          <input type="file" id="kolam-upload" accept="image/*" />
        </label>
        <div class="info">JPG, PNG â€¢ Max 2MB</div>
      </div>
      <div class="anim-panel">
        <h2>2. Kolam Animation</h2>
        <div class="anim-area" id="anim-area">
          <div class="anim-placeholder" id="anim-placeholder">Upload a Kolam image and press <b>Animate</b> to view the tracing animation!</div>
          <canvas id="animationCanvas" width="410" height="340"></canvas>
        </div>
        <div class="actions">
          <button id="animate-btn" disabled>Animate</button>
          <button id="back20" disabled>&laquo; 20 Frames</button>
          <button id="forward20" disabled>20 Frames &raquo;</button>
        </div>
      </div>
    </div>

    <script>
      // Functionality script adapted for this layout/IDs
      const fileInput = document.getElementById('kolam-upload');
      const previewImg = document.getElementById('preview-img');
      const previewPlaceholder = document.getElementById('preview-placeholder');
      const animateBtn = document.getElementById('animate-btn');
      const canvas = document.getElementById('animationCanvas');
      const ctx = canvas.getContext('2d');
      const back20Btn = document.getElementById('back20');
      const forward20Btn = document.getElementById('forward20');

      let frames = [];
      let currentFrame = 0;
      let liveInterval = null;
      let navImg = new Image();
      let currentFile = null;

      fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
          handleFileUpload(event.target.files[0]);
        }
      });

      function handleFileUpload(file) {
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file.');
          return;
        }

        if (file.size > 2 * 1024 * 1024) {
          alert('File size exceeds 2MB.');
          return;
        }

        currentFile = file;

        const reader = new FileReader();
        reader.onload = () => {
          previewImg.src = reader.result;
          previewImg.style.display = 'block';
          previewPlaceholder.style.display = 'none';
          animateBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          currentFile = event.target.files[0];
          previewImg.src = URL.createObjectURL(file);
          previewImg.style.display = '';
          previewPlaceholder.style.display = 'none';
          animateBtn.disabled = false;
        } else {
          currentFile = null;
          previewImg.style.display = 'none';
          previewPlaceholder.style.display = '';
          animateBtn.disabled = true;
        }
      });

      animateBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        if (!file) {
          const file = currentFile;
          if (!file) return alert('Select a file.');
        }

        frames = [];
        currentFrame = 0;
        back20Btn.disabled = true;
        forward20Btn.disabled = true;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        previewImg.src = URL.createObjectURL(file);

        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/upload_kolam', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.error) return alert('Error: ' + data.error);

        if (liveInterval) clearInterval(liveInterval);

        const streamImg = new Image();
        streamImg.src = `/animate_kolam?csv_file=${encodeURIComponent(data.csv_file)}`;
        streamImg.crossOrigin = 'anonymous';

        liveInterval = setInterval(() => {
          try {
            ctx.drawImage(streamImg, 0, 0, canvas.width, canvas.height);
          } catch (e) {}
        }, 30);

        const pollSnapshots = async () => {
          try {
            const snapRes = await fetch(`/kolam_snapshots`);
            if (!snapRes.ok) {
              setTimeout(pollSnapshots, 4000);
              return;
            }
            const snapData = await snapRes.json();

            frames = snapData.frames;
            currentFrame = frames.length - 1;

            clearInterval(liveInterval);

            navImg.onload = () => ctx.drawImage(navImg, 0, 0, canvas.width, canvas.height);
            navImg.src = 'data:image/jpeg;base64,' + frames[currentFrame];

            back20Btn.disabled = false;
            forward20Btn.disabled = false;
          } catch (err) {
            setTimeout(pollSnapshots, 4000);
          }
        };
        pollSnapshots();
      });

      function updateFrame(idx) {
        if (frames.length === 0) return;
        currentFrame = Math.max(0, Math.min(idx, frames.length - 1));
        navImg.onload = () => ctx.drawImage(navImg, 0, 0, canvas.width, canvas.height);
        navImg.src = 'data:image/jpeg;base64,' + frames[currentFrame];
      }

      back20Btn.addEventListener('click', () => updateFrame(currentFrame - 20));
      forward20Btn.addEventListener('click', () => updateFrame(currentFrame + 20));
    </script>
  </body>
</html>
